<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>70x30 Sticker Generator</title>

  <!-- JsBarcode & jsPDF from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f4f4f4;
    }
    h1 {
      text-align: center;
      margin-bottom: 12px;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    textarea {
      width: 100%;
      height: 150px;
      font-family: Consolas, monospace;
      font-size: 13px;
      padding: 8px;
      box-sizing: border-box;
      margin-bottom: 10px;
    }
    button {
      padding: 8px 16px;
      margin-right: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    #previewBtn { background:#007bff; color:#fff; }
    #downloadBtn { background:#28a745; color:#fff; }
    #message { margin-top: 8px; color:#d9534f; font-size: 13px; }

    .preview-area {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .sticker {
      width: 280px;
      height: 120px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 6px;
      text-align: center;
    }
    .sticker-desc {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 4px;
    }
    .sticker-code {
      font-size: 12px;
      margin-bottom: 4px;
    }
    canvas.barcodeCanvas {
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <h1>70mm × 30mm Sticker Generator</h1>
  <div class="container">
    <p><strong>Input format:</strong> <code>MATERIALIDDescriptionBARCODE</code><br>
       Example: <code>205722Javino Moist. 100Gm Cream06285128002707</code></p>

    <textarea id="rawInput" placeholder="Paste your lines here..."></textarea>

    <div>
      <button id="previewBtn">Preview</button>
      <button id="downloadBtn">Download PDF</button>
    </div>
    <div id="message"></div>

    <div class="preview-area" id="previewArea"></div>
  </div>

<script>
  // NEW PARSER: always take the last digits as barcode, ignore dots in description
  function parseLine(line) {
    line = line.trim();
    if (!line) return null;

    // first 6 digits = material number
    const materialId = line.slice(0, 6).replace(/\D/g, '');
    if (!materialId) return null;

    let rest = line.slice(6).trim();
    if (!rest) return null;

    // Everything until the last block of digits is description,
    // last block of digits is barcode (even if there are dots earlier).
    const match = rest.match(/(.*?)(\d+)\s*$/);
    let description = '';
    let barcodeNumber = '';

    if (match) {
      description = match[1].trim();
      barcodeNumber = match[2].trim();
    } else {
      description = rest;
      barcodeNumber = '';
    }

    return {
      materialId,
      description,
      barcodeNumber
    };
  }

  let parsedItems = [];

  function buildPreview() {
    const input = document.getElementById('rawInput').value;
    const lines = input.split(/\r?\n/);

    parsedItems = [];
    const previewArea = document.getElementById('previewArea');
    const msg = document.getElementById('message');
    previewArea.innerHTML = '';
    msg.textContent = '';

    lines.forEach((line, index) => {
      const item = parseLine(line);
      if (!item) return;
      parsedItems.push(item);

      const sticker = document.createElement('div');
      sticker.className = 'sticker';

      const descEl = document.createElement('div');
      descEl.className = 'sticker-desc';
      descEl.textContent = item.description;

      const codeEl = document.createElement('div');
      codeEl.className = 'sticker-code';
      codeEl.textContent = item.barcodeNumber;

      const canvas = document.createElement('canvas');
      canvas.className = 'barcodeCanvas';
      canvas.id = 'barcodeCanvas_' + index;

      sticker.appendChild(descEl);
      sticker.appendChild(codeEl);
      sticker.appendChild(canvas);
      previewArea.appendChild(sticker);

      // Small barcode – encodes MATERIAL NUMBER
      if (item.materialId && item.materialId !== '0') {
        JsBarcode(canvas, item.materialId, {
          format: "CODE128",
          width: 1,
          height: 30,
          displayValue: false,
          margin: 0
        });
      }
    });

    if (!parsedItems.length) {
      msg.textContent = "No valid lines found. Check your input format.";
    } else {
      msg.textContent = "Preview generated for " + parsedItems.length + " stickers.";
    }
  }

  async function downloadPDF() {
    if (!parsedItems.length) {
      buildPreview();
      if (!parsedItems.length) return;
    }

    const msg = document.getElementById('message');
    msg.textContent = "Building PDF...";

    const { jsPDF } = window.jspdf;
    // Page size: 70mm x 30mm (landscape)
    const doc = new jsPDF({
      orientation: "landscape",
      unit: "mm",
      format: [30, 70] // [height, width]
    });

    for (let i = 0; i < parsedItems.length; i++) {
      const item = parsedItems[i];
      if (i > 0) doc.addPage();

      // Description
      doc.setFont("Helvetica", "bold");
      doc.setFontSize(13);
      const descLines = doc.splitTextToSize(item.description, 60);
      doc.text(descLines, 35, 8, { align: "center" });

      // Barcode number (below description)
      doc.setFont("Helvetica", "normal");
      doc.setFontSize(8);
      doc.text(item.barcodeNumber || "", 35, 17, { align: "center" });

      // Barcode (material number)
      const canvas = document.getElementById('barcodeCanvas_' + i);
      if (canvas && item.materialId && item.materialId !== '0') {
        const imgData = canvas.toDataURL("image/png");
        doc.addImage(imgData, "PNG", 15, 19, 40, 8);
      }
    }

    doc.save("stickers_70x30mm.pdf");
    msg.textContent = "PDF downloaded.";
  }

  document.getElementById('previewBtn').addEventListener('click', buildPreview);
  document.getElementById('downloadBtn').addEventListener('click', downloadPDF);
</script>
</body>
</html>
